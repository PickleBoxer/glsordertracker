{#**
 * Copyright since 2007 PrestaShop SA and Contributors
 * PrestaShop is an International Registered Trademark & Property of PrestaShop SA
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License version 3.0
 * that is bundled with this package in the file LICENSE.md.
 * It is also available through the world-wide-web at this URL:
 * https://opensource.org/licenses/AFL-3.0
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@prestashop.com so we can send you a copy immediately.
 *
 * @author    PrestaShop SA and Contributors <contact@prestashop.com>
 * @copyright Since 2007 PrestaShop SA and Contributors
 * @license   https://opensource.org/licenses/AFL-3.0 Academic Free License version 3.0
 *#}
{% extends '@Modules/glsordertracker/views/templates/admin/card.html.twig' %}

{% block card_title %}
{{ 'Order Tracking'|trans }}
{% endblock %}

{% block card_body %}
<!-- Details-->
<p class="mb-1">
    <strong>Customer:</strong>
</p>
<p>
    {{ tracker.firstName }} {{ tracker.lastName }}
</p>
<p class="mb-1"></p>
<strong>Order Status:</strong>
</p>
<p>{{ tracker.orderStatusName}}</p>
<p class="mb-1">
    <strong>Tracking number:</strong>
</p>
<p>{{ tracker.shippingNumber}}</p>

<!-- Progress-->
<div class="steps">
    <div class="steps-header">
        {% set width_map = {3: '50%', 4: '83.33%', 5: '100%'} %}
        {% set width = width_map[tracker.orderStatusId] | default('0%') %}
        {% set aria_valuenow = width_map[tracker.orderStatusId] | default('0') %}

        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                style="width: {{ width }}" aria-valuenow="{{ aria_valuenow }}" aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
    </div>
    <div class="steps-body">
        <div
            class="step {% if tracker.orderStatusId == 3 or tracker.orderStatusId == 4 or tracker.orderStatusId == 5 %}step-completed{% endif %}">
            {% if tracker.orderStatusId == 3 or tracker.orderStatusId == 4 or tracker.orderStatusId == 5 %}<span
                class="step-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="feather feather-check">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg></span>{% endif %}<span class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg></span>Processing order</div>
        <!--<div class="step step-active"><span class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg></span>Quality check</div>-->
        <div
            class="step {% if tracker.orderStatusId == 4 or tracker.orderStatusId == 5 %}step-completed{% endif %} {% if tracker.orderStatusId == 3 %}step-active{% endif %}">
            {% if tracker.orderStatusId == 4 or tracker.orderStatusId == 5 %}<span class="step-indicator"><svg
                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-check">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg></span>{% endif %}<span class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="feather feather-truck">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg></span>Shipped</div>
        <div
            class="step {% if tracker.orderStatusId == 5  %}step-completed{% endif %} {% if tracker.orderStatusId == 4 %}step-active{% endif %}">
            {% if tracker.orderStatusId == 5 %}<span class="step-indicator"><svg xmlns="http://www.w3.org/2000/svg"
                    width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="feather feather-check">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg></span>{% endif %}<span class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg></span>Delivered</div>
    </div>
</div>
<!-- Footer-->
<div class="d-sm-flex flex-wrap justify-content-between align-items-center text-center pt-4">
    <div class="custom-control custom-checkbox mt-2 mr-3">
        <input disabled class="custom-control-input" type="checkbox" id="notify-me" checked="">
        <label class="custom-control-label" for="notify-me">Notify me when order is delivered</label>
    </div><a id="trackButton" class="btn btn-primary btn-sm mt-2" href="#order-tracking" data-toggle="modal">View
        Tracking Details</a>
</div>

<!-- Modal Structure -->
<div class="modal fade" id="order-tracking" tabindex="-1" role="dialog" aria-labelledby="orderTrackingLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderTrackingLabel">Tracking Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="trackingInfo">Loading...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('#trackButton').click(function () {
            $.ajax({
                url: '{{ ajaxUrl }}',
                cache: false,
                type: 'POST',
                data: {
                    ajax: true,
                    action: 'trackOrder',
                    shippingNumber: '{{ tracker.shippingNumber }}',
                },
                success: function (data) {
                    if (data.success) {
                        const trackingData = data.trackingData;
                        const lastTracking = data.lastTracking;
                        const city = data.city;
                        const coordinates = data.coordinates;

                        let html = '<ul class="list-group list-group-flush">';
                        trackingData.forEach(tracking => {
                            html += `
                        <li class="list-group-item d-flex align-items-start">
                            <div class="me-3">
                                <div class="bg-primary text-white rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="bi bi-truck"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1">${tracking.status_desc}</h6>
                                <p class="mb-1 text-muted">${tracking.date} at ${tracking.time}</p>
                                <p class="mb-0">${tracking.city}</p>
                                ${tracking.note ? `<p class="mb-0 text-muted">${tracking.note}</p>` : ''}
                                ${tracking.status_desc === lastTracking.status_desc ? `
                                    ${coordinates ? `
                                        <div class="mt-3">
                                            <img class="img-fluid rounded" src="https://maps.geoapify.com/v1/staticmap?style=maptiler-3d&width=300&height=300&center=lonlat:${coordinates[0]},${coordinates[1]}&zoom=14&marker=lonlat:${coordinates[0]},${coordinates[1]};color:%23ff0000;size:medium&apiKey=1f36133f60b4441098742d4ddf4009a5" alt="Map of ${city}">
                                        </div>
                                    ` : `
                                        <div class="alert alert-warning mt-3">Unable to fetch coordinates for ${city}</div>
                                    `}
                                ` : ''}
                            </div>
                        </li>`;
                        });
                        html += '</ul>';

                        $('#trackingInfo').html(html);
                    } else {
                        $('#trackingInfo').html(data.message);
                    }
                },
                error: function () {
                    $('#trackingInfo').text('Error retrieving tracking information.');
                }
            });
        });
    });
</script>

<style>
    .steps {
        border: 1px solid #e7e7e7
    }

    .steps-header {
        padding: .375rem;
        border-bottom: 1px solid #e7e7e7
    }

    .steps-header .progress {
        height: .25rem
    }

    .steps-body {
        display: table;
        table-layout: fixed;
        width: 100%
    }

    .step {
        display: table-cell;
        position: relative;
        padding: 1rem .75rem;
        -webkit-transition: all 0.25s ease-in-out;
        transition: all 0.25s ease-in-out;
        border-right: 1px dashed #dfdfdf;
        color: rgba(0, 0, 0, 0.65);
        font-weight: 600;
        text-align: center;
        text-decoration: none
    }

    .step:last-child {
        border-right: 0
    }

    .step-indicator {
        display: block;
        position: absolute;
        top: .75rem;
        left: .75rem;
        width: 1.5rem;
        height: 1.5rem;
        border: 1px solid #e7e7e7;
        border-radius: 50%;
        background-color: #fff;
        font-size: .875rem;
        line-height: 1.375rem
    }

    .has-indicator {
        padding-right: 1.5rem;
        padding-left: 2.375rem
    }

    .has-indicator .step-indicator {
        top: 50%;
        margin-top: -.75rem
    }

    .step-icon {
        display: block;
        width: 1.5rem;
        height: 1.5rem;
        margin: 0 auto;
        margin-bottom: .75rem;
        -webkit-transition: all 0.25s ease-in-out;
        transition: all 0.25s ease-in-out;
        color: #888
    }

    .step:hover {
        color: rgba(0, 0, 0, 0.9);
        text-decoration: none
    }

    .step:hover .step-indicator {
        -webkit-transition: all 0.25s ease-in-out;
        transition: all 0.25s ease-in-out;
        border-color: transparent;
        background-color: #f4f4f4
    }

    .step:hover .step-icon {
        color: rgba(0, 0, 0, 0.9)
    }

    .step-active,
    .step-active:hover {
        color: rgba(0, 0, 0, 0.9);
        pointer-events: none;
        cursor: default
    }

    .step-active .step-indicator,
    .step-active:hover .step-indicator {
        border-color: transparent;
        background-color: #5c77fc;
        color: #fff
    }

    .step-active .step-icon,
    .step-active:hover .step-icon {
        color: #5c77fc
    }

    .step-completed .step-indicator,
    .step-completed:hover .step-indicator {
        border-color: transparent;
        background-color: rgba(51, 203, 129, 0.12);
        color: #33cb81;
        line-height: 1.25rem
    }

    .step-completed .step-indicator .feather,
    .step-completed:hover .step-indicator .feather {
        width: .875rem;
        height: .875rem
    }

    @media (max-width: 575.98px) {
        .steps-header {
            display: none
        }

        .steps-body,
        .step {
            display: block
        }

        .step {
            border-right: 0;
            border-bottom: 1px dashed #e7e7e7
        }

        .step:last-child {
            border-bottom: 0
        }

        .has-indicator {
            padding: 1rem .75rem
        }

        .has-indicator .step-indicator {
            display: inline-block;
            position: static;
            margin: 0;
            margin-right: 0.75rem
        }
    }

    .bg-secondary {
        background-color: #f7f7f7 !important;
    }
</style>
{% endblock %}